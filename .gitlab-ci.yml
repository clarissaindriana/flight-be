stages:
  - build
  - docker-push
  - deploy

variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA

build:
  stage: build
  image: eclipse-temurin:21-jdk
  only:
    - master
  script:
    - chmod +x ./gradlew
    - ./gradlew clean build -x test
    - cp $(find build/libs -name "*.jar" | head -n 1) app.jar
  artifacts:
    paths:
      - app.jar
      - Dockerfile
      - k8s/deployment.yaml
      - k8s/service.yaml
      - k8s/ingress.yaml
    expire_in: 1 hour

docker-push:
  stage: docker-push
  image: docker:24
  services:
    - docker:24-dind
  only:
    - master
  dependencies:
    - build
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - docker build -t $DOCKER_IMAGE_NAME:$IMAGE_TAG .
    - docker push $DOCKER_IMAGE_NAME:$IMAGE_TAG
    - docker tag $DOCKER_IMAGE_NAME:$IMAGE_TAG $DOCKER_IMAGE_NAME:latest
    - docker push $DOCKER_IMAGE_NAME:latest
    - echo "Docker image pushed successfully - $DOCKER_IMAGE_NAME:$IMAGE_TAG"

deploy:
  stage: deploy
  image: alpine:latest
  only:
    - master
  dependencies:
    - build
  before_script:
    - apk add --no-cache openssh bash
    - mkdir -p ~/.ssh
    - echo "$EC2_SSH_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
  script:
    - echo "Generating Kubernetes ConfigMap & Secret for flight-2306211660-be..."
    - |
      printf "apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: flight-2306211660-be-config\n  namespace: default\ndata:\n  DATABASE_URL_PROD: \"%s\"\n  DATABASE_USERNAME: \"%s\"\n" \
      "$DATABASE_URL_PROD" "$DATABASE_USERNAME" > configmap.yaml
    - |
      printf "apiVersion: v1\nkind: Secret\nmetadata:\n  name: flight-2306211660-be-secret\n  namespace: default\ntype: Opaque\nstringData:\n  DATABASE_PASSWORD: \"%s\"\n" \
      "$DATABASE_PASSWORD" > secret.yaml
    - sed "s|REPLACE_ME_TAG|$IMAGE_TAG|g" k8s/deployment.yaml > deployment.yaml
    - echo "Deploying to EC2 Kubernetes cluster..."
    - ssh $EC2_USER@$EC2_HOST "mkdir -p ~/app/2306211660-flight-be/k8s"
    - scp deployment.yaml configmap.yaml secret.yaml k8s/service.yaml k8s/ingress.yaml $EC2_USER@$EC2_HOST:~/app/2306211660-flight-be/k8s/
    - |
      ssh $EC2_USER@$EC2_HOST "
        sudo k3s kubectl apply -f ~/app/2306211660-flight-be/k8s/configmap.yaml &&
        sudo k3s kubectl apply -f ~/app/2306211660-flight-be/k8s/secret.yaml &&
        sudo k3s kubectl apply -f ~/app/2306211660-flight-be/k8s/deployment.yaml &&
        sudo k3s kubectl apply -f ~/app/2306211660-flight-be/k8s/service.yaml &&
        sudo k3s kubectl apply -f ~/app/2306211660-flight-be/k8s/ingress.yaml &&
        sudo k3s kubectl rollout status deployment/flight-2306211660-be -n default --timeout=5m
      "
    - echo "Deployment completed successfully!"
